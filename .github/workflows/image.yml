name: Build Images

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Image version (e.g., 0.3.1)'
        required: true
        default: '0.3.1'

jobs:
  build-image-x86_64:
    runs-on: ubuntu-latest
    container:
      image: fedora:43
      options: --privileged

    steps:
      - name: Install dependencies
        run: |
          dnf install -y \
            git \
            mkosi \
            systemd-container \
            qemu-img \
            xz

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set file permissions
        run: |
          chmod 755 mkosi-extra/usr/local/bin/*.sh
          chmod 600 mkosi-extra/etc/doas.conf

      - name: Build image
        run: mkosi --force --profile=x86_64 --image-version=${{ github.event.inputs.version }}

      - name: Convert and compress images
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          cd output
          mv *.raw arexibo-kiosk_${VERSION}_x86_64.raw
          qemu-img convert -f raw -O qcow2 -c arexibo-kiosk_${VERSION}_x86_64.raw arexibo-kiosk_${VERSION}_x86_64.qcow2
          qemu-img resize arexibo-kiosk_${VERSION}_x86_64.qcow2 16G
          xz -T0 -9 arexibo-kiosk_${VERSION}_x86_64.raw

      - name: List output
        run: ls -lah output/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: images-x86_64
          path: |
            output/*.qcow2
            output/*.raw.xz
          retention-days: 30

  build-image-aarch64:
    runs-on: ubuntu-24.04-arm
    container:
      image: fedora:43
      options: --privileged

    steps:
      - name: Install dependencies
        run: |
          dnf install -y \
            git \
            mkosi \
            systemd-container \
            xz

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set file permissions
        run: |
          chmod 755 mkosi-extra/usr/local/bin/*.sh
          chmod 600 mkosi-extra/etc/doas.conf

      - name: Build image
        run: mkosi --force --profile=aarch64 --image-version=${{ github.event.inputs.version }}

      - name: Rename with arch
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          cd output
          mv arexibo-kiosk_${VERSION}.raw arexibo-kiosk_${VERSION}_aarch64.raw

      - name: Compress image
        run: |
          cd output
          xz -T0 -9 arexibo-kiosk_${{ github.event.inputs.version }}_aarch64.raw

      - name: List output
        run: ls -lah output/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: images-aarch64
          path: output/*.raw.xz
          retention-days: 30

  release:
    needs: [build-image-x86_64, build-image-aarch64]
    runs-on: ubuntu-latest

    steps:
      - name: Download image artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: images-*
          merge-multiple: true

      - name: Download RPMs from latest rpm.yml run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID=$(gh run list -R "${{ github.repository }}" -w rpm.yml -s success -L1 --json databaseId -q '.[0].databaseId')
          if [ -z "$RUN_ID" ]; then
            echo "ERROR: No successful rpm.yml run found"
            exit 1
          fi
          echo "Downloading RPMs from run $RUN_ID"
          gh run download "$RUN_ID" -R "${{ github.repository }}" -p 'rpms-*' -D artifacts/

      - name: Flatten files
        run: |
          mkdir -p release
          find artifacts -name "*.rpm" -exec mv {} release/ \;
          find artifacts -name "*.qcow2" -exec mv {} release/ \;
          find artifacts -name "*.raw.xz" -exec mv {} release/ \;
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          files: release/*
          draft: false
          prerelease: false
          body: |
            ## Arexibo Kiosk

            ### RPM Installation (Fedora 43)

            Add the repository and install:

            ```bash
            sudo dnf copr enable linuxnow/arexibo  # or use the GitHub Pages repo
            sudo dnf install arexibo
            ```

            Or install directly from the RPM:

            ```bash
            sudo dnf install ./arexibo-*.rpm
            ```

            ### Disk Images

            - **QCOW2** (x86_64): For VMs (GNOME Boxes, virt-manager, QEMU)
            - **Raw.xz** (x86_64 / aarch64): For flashing to physical hardware

            Default credentials: `root` / `root`, `xibo` / `xibo`
            ⚠️ **Change passwords after first login!**

            ```bash
            # Test in QEMU
            qemu-system-x86_64 -enable-kvm -m 2G -drive file=arexibo-kiosk_*_x86_64.qcow2

            # Flash to hardware
            xz -dc arexibo-kiosk_*_x86_64.raw.xz | sudo dd of=/dev/sdX bs=8M status=progress
            ```

            After booting, a setup wizard will configure your Xibo CMS connection.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
